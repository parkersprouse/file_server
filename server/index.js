import U from"fs";import S from"path";import q from"@hapi/hapi";import ee from"@hapi/inert";import te from"@hapi/vision";import C from"handlebars";import re from"qs";import H from"dotenv";H.config();var d={file_source:process.argv[2]||process.env.FILE_SERVER_FILES_SOURCE,host:process.env.FILE_SERVER_HOST||"0.0.0.0",port:process.env.FILE_SERVER_PORT||3e3};import P from"path";var L={method:"GET",path:"/assets/{any*}",handler:function(e,t){try{return t.file(P.join(t.request.server.settings.app.__dirname,e.path),{confine:!1})}catch{return t.view("404").code(404)}}};import f from"fs";import s from"path";import{fileTypeFromFile as B}from"file-type";import{cloneDeep as A,orderBy as J}from"lodash-es";import h from"qs";import V from"fs";import{execa as z}from"execa";import M from"@ffprobe-installer/ffprobe";function N(e){let t=["-v","error","-show_format","-show_streams"];if(typeof e=="string")return z(M.path,[...t,e]);throw new Error("Given input was not a string")}async function v(e){try{let{stdout:t}=await N(e),o=t.match(/duration="?(\d*\.\d*)"?/);if(o&&o[1])return parseFloat(o[1]);throw new Error("No duration found!")}catch(t){return console.error(t),0}}function g(e){return new Date(1e3*e).toISOString().substring(11,19)}function j(e){try{return V.statSync(e).mtimeMs||-1}catch(t){return console.error(t),-1}}function R(e){return new Date(e).toLocaleString("en-US",{day:"numeric",hour:"2-digit",hour12:!1,minute:"2-digit",month:"short",year:"numeric"})}var K=Object.freeze(["list","grid"]),Q=Object.freeze(["name","duration","last_updated"]);async function X(e,t,o,i,r){let c=K.includes(e.query.view?.toLowerCase())?e.query.view.toLowerCase():"list",x=Q.includes(e.query.sort?.toLowerCase())?e.query.sort.toLowerCase():"name",E=f.readdirSync(i,{withFileTypes:!0});if(r.startsWith("/.thumbnails"))return t.view("404").code(404);let p=[];for(let _=0;_<E.length;_+=1){let a=E[_],y=a.isDirectory();if(a.name===".thumbnails")continue;let W=encodeURIComponent(a.name),$=s.join(i,W),O=s.relative(o,$),l=s.join(i,a.name),b=j(l),n={name:a.name,path:`${O}?${h.stringify(e.query)}`,icon:y?"ri-folder-line":"ri-file-line",type:y?"folder":"file",last_updated:R(b),raw_last_updated:b};if(!y){let w=await B(l);if(w?.mime?.startsWith("image"))n.icon="ri-image-2-line",n.type="image",c==="grid"&&(n.src=s.join(r,a.name));else if(w?.mime?.startsWith("video")){n.icon="ri-film-line",n.type="video";let u=await v(l);n.duration=g(u),n.raw_duration=u;let k=a.name.replace(s.extname(a.name),".png"),G=s.join(o,".thumbnails",r,k);f.existsSync(G)&&(n.thumbnail=s.join("/.thumbnails",r,encodeURIComponent(a.name.replace(s.extname(a.name),".png"))))}else if(w?.mime?.startsWith("audio")){n.icon="ri-headphone-line",n.type="audio";let u=await v(l);n.duration=g(u),n.raw_duration=u}l.toLowerCase().endsWith(".url")&&(n.icon="ri-external-link-line",f.readFileSync(l).toString("utf8").split(`
`).forEach(u=>{u.trim().startsWith("URL=")&&(n.external_url=u.split("=")[1])}))}p.push(n)}p=Z(p,x);let I=`/?${h.stringify(e.query)}`,T=e.path==="/"?null:`${s.join(r,"..")}?${h.stringify(e.query)}`;return t.view("page",{duration_sort_url:m(r,e.query,"sort","duration"),files:p,grid_view_url:m(r,e.query,"view","grid"),last_updated_sort_url:m(r,e.query,"sort","last_updated"),list_view_url:m(r,e.query,"view","list"),name_sort_url:m(r,e.query,"sort","name"),previous_url:T,root_url:I,sort_param:x,view_param:c})}function Y(e,t){return e.file(t,{confine:!1,mode:"inline",etagMethod:"simple"}).code(200)}function m(e,t,o,i){let r=A(t);return r[o]=i,`${e}?${h.stringify(r)}`}function Z(e,t){let o=[r=>r.type==="folder",r=>r.name.match(/^\W+/)===null,r=>r.name.toLowerCase()],i=["desc","asc","asc"];switch(t){case"duration":o.splice(1,0,r=>r.raw_duration||0),i.splice(1,0,"desc");break;case"last_updated":o.splice(1,0,r=>r.raw_last_updated||-1),i.splice(1,0,"desc");break;default:break}return J(e,o,i)}var D={method:"GET",path:"/{any*}",handler:function(e,t){try{let{root_path:o}=t.request.server.settings.app,i=decodeURIComponent(e.path),r=s.join(o,i),c=f.statSync(r);return c.isDirectory()?X(e,t,o,r,i):c.isFile()?Y(t,r):t.view("404").code(404)}catch{return t.view("404").code(404)}}};var F={method:"*",path:"/{any*}",handler:function(e,t){return t.view("404").code(404)}};async function oe(){let e=d.file_source;if(!e)throw"No file source path provided";if(!U.existsSync(e)||!U.statSync(e).isDirectory())throw"Invalid file source path provided";C.registerHelper("ifEquals",function(i,r,c){return i==r?c.fn(this):c.inverse(this)});let t=S.resolve("."),o=q.server({app:{__dirname:t,config:d,root_path:e},port:d.port,host:d.host,router:{stripTrailingSlash:!0},routes:{files:{relativeTo:e}},query:{parser:i=>re.parse(i)}});await o.register(ee),await o.register(te),o.views({engines:{html:C},relativeTo:t,path:S.join(t,"server","templates"),partialsPath:S.join(t,"server","templates","partials")}),o.route(L),o.route(D),o.route(F),await o.start(),console.log("Server running on %s",o.info.uri)}process.on("unhandledRejection",e=>{console.error(e),process.exit(1)});oe();
//# sourceMappingURL=index.js.map
