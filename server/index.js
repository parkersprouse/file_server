import k from"fs";import E from"path";import st from"@hapi/hapi";import at from"@hapi/inert";import ct from"@hapi/vision";import W from"handlebars";import ut from"qs";import V from"dotenv";V.config();var m={file_source:process.argv[2]||process.env.FILE_SERVER_FILES_SOURCE,host:process.env.FILE_SERVER_HOST||"0.0.0.0",port:process.env.FILE_SERVER_PORT||3e3};import z from"path";var $={method:"GET",path:"/{any*}",handler:function(t,e){try{return e.file(z.join(e.request.server.settings.app.__dirname,"server",t.path),{confine:!1})}catch{return e.view("404").code(404)}}};import y from"fs";import d from"path";import{fileTypeFromFile as tt}from"file-type";import et from"qs";import M from"fs";import{execa as N}from"execa";import Q from"@ffprobe-installer/ffprobe";import{cloneDeep as q,isEmpty as A,orderBy as J,without as K}from"lodash-es";import X from"qs";function Y(t){return t==="/"||t==="/f"}function Z(t){let e=["-v","error","-show_format","-show_streams"];if(typeof t=="string")return N(Q.path,[...e,t]);throw new Error("Given input was not a string")}function x(t){return new Date(1e3*t).toISOString().substring(11,19)}function j(t){return new Date(t).toLocaleString("en-US",{day:"numeric",hour:"2-digit",hour12:!1,minute:"2-digit",month:"short",year:"numeric"})}async function b(t){try{let{stdout:e}=await Z(t),o=e.match(/duration="?(\d*\.\d*)"?/);if(o&&o[1])return parseFloat(o[1]);throw new Error("No duration found!")}catch(e){return console.error(e),0}}function D(t){try{return M.statSync(t).mtimeMs||-1}catch(e){return console.error(e),-1}}function f(t,e,o,i){let r=q(e);return r[o]=i,`/f/${p(t)}${l(r)}`}function l(t){return A(t)?"":`?${X.stringify(t)}`}function F(t,e){let o=[r=>r.type==="folder",r=>r.name.match(/^\W+/)===null,r=>r.name.toLowerCase()],i=["desc","asc","asc"];switch(e){case"duration":o.splice(1,0,r=>r.raw_duration||0),i.splice(1,0,"desc");break;case"last_updated":o.splice(1,0,r=>r.raw_last_updated||-1),i.splice(1,0,"desc");break;default:break}return J(t,o,i)}function p(t){let e=t.replace(/\/+/g,"/");return e.startsWith("/")?e.substring(1):e}function C(t,e){let o=t.split("/").filter(r=>!!r),i=K(o,"f");return[{label:"Root",skip_link:Y(t),url:`/f${l(e)}`},...i.map((r,s)=>{let h=`/f/${i.slice(0,s+1).join("/")}${l(e)}`;return{label:r,url:h,skip_link:s===i.length-1}})]}var rt=Object.freeze(["list","grid"]),ot=Object.freeze(["name","duration","last_updated"]);async function it(t,e,o,i,r){let s=rt.includes(t.query.view?.toLowerCase())?t.query.view.toLowerCase():"list",h=ot.includes(t.query.sort?.toLowerCase())?t.query.sort.toLowerCase():"name",S=y.readdirSync(i,{withFileTypes:!0});if(r.startsWith("/.thumbnails"))return e.view("404").code(404);let _=[];for(let w=0;w<S.length;w+=1){let a=S[w],g=a.isDirectory();if(a.name===".thumbnails")continue;let B=encodeURIComponent(a.name),G=d.join(i,B),H=d.relative(o,G),u=d.join(i,a.name),R=D(u),n={icon:g?"ri-folder-line":"ri-file-line",last_updated:j(R),name:a.name,path:`/f/${p(H)}${l(t.query)}`,raw_last_updated:R,type:g?"folder":"file"};if(!g){let v=await tt(u);if(v?.mime?.startsWith("image"))n.icon="ri-image-2-line",n.type="image",s==="grid"&&(n.src=`/f/${p(r)}/${a.name}`);else if(v?.mime?.startsWith("video")){n.icon="ri-film-line",n.type="video";let c=await b(u);n.duration=x(c),n.raw_duration=c;let U=a.name.replace(d.extname(a.name),".png"),P=d.join(o,".thumbnails",r,U);y.existsSync(P)&&(n.thumbnail=`/f/.thumbnails/${p(r)}/${p(encodeURIComponent(U))}`)}else if(v?.mime?.startsWith("audio")){n.icon="ri-headphone-line",n.type="audio";let c=await b(u);n.duration=x(c),n.raw_duration=c}u.toLowerCase().endsWith(".url")&&(n.icon="ri-external-link-line",y.readFileSync(u).toString("utf8").split(`
`).forEach(c=>{c.trim().startsWith("URL=")&&(n.external_url=c.split("=")[1])}))}_.push(n)}_=F(_,h);let L=et.stringify(t.query),O=C(r,L);return e.view("page",{breadcrumbs:O,duration_sort_url:f(r,t.query,"sort","duration"),files:_,grid_view_url:f(r,t.query,"view","grid"),last_updated_sort_url:f(r,t.query,"sort","last_updated"),list_view_url:f(r,t.query,"view","list"),name_sort_url:f(r,t.query,"sort","name"),root_url:`/f${l(L)}`,sort_param:h,view_param:s})}function nt(t,e){return t.file(e,{confine:!1,mode:"inline",etagMethod:"simple"}).code(200)}var I={method:"GET",path:"/f/{any*}",handler:function(t,e){try{let{root_path:o}=e.request.server.settings.app,i=decodeURIComponent(t.path).replace(/^\/f/,"").replace(/\/+/g,"/")||"/",r=d.join(o,i),s=y.statSync(r);return s.isDirectory()?it(t,e,o,r,i):s.isFile()?nt(e,r):e.view("404").code(404)}catch{return e.view("404").code(404)}}};var T={method:"*",path:"/{any*}",handler:function(t,e){return e.view("404").code(404)}};async function lt(){let t=m.file_source;if(!t)throw"No file source path provided";if(!k.existsSync(t)||!k.statSync(t).isDirectory())throw"Invalid file source path provided";W.registerHelper("ifEquals",function(i,r,s){return i==r?s.fn(this):s.inverse(this)});let e=E.resolve("."),o=st.server({app:{__dirname:e,config:m,root_path:t},port:m.port,host:m.host,router:{stripTrailingSlash:!0},routes:{files:{relativeTo:t}},query:{parser:i=>ut.parse(i)}});await o.register(at),await o.register(ct),o.views({engines:{html:W},relativeTo:e,path:E.join(e,"server","templates"),partialsPath:E.join(e,"server","templates","partials")}),o.ext("onRequest",(i,r)=>(i.path==="/"&&i.setUrl("/f"),r.continue)),o.route(I),o.route($),o.route(T),await o.start(),console.log("Server running on %s",o.info.uri)}process.on("unhandledRejection",t=>{console.error(t),process.exit(1)});lt();
//# sourceMappingURL=index.js.map
