import W from"fs";import x from"path";import ot from"@hapi/hapi";import it from"@hapi/inert";import nt from"@hapi/vision";import O from"handlebars";import st from"qs";import V from"dotenv";V.config();var d={file_source:process.argv[2]||process.env.FILE_SERVER_FILES_SOURCE,host:process.env.FILE_SERVER_HOST||"0.0.0.0",port:process.env.FILE_SERVER_PORT||3e3};import z from"path";var U={method:"GET",path:"/{any*}",handler:function(t,e){try{return e.file(z.join(e.request.server.settings.app.__dirname,"server",t.path),{confine:!1})}catch{return e.view("404").code(404)}}};import _ from"fs";import p from"path";import{fileTypeFromFile as Z}from"file-type";import I from"qs";import M from"fs";import{execa as N}from"execa";import A from"@ffprobe-installer/ffprobe";import{cloneDeep as J,orderBy as K,without as Q}from"lodash-es";import X from"qs";function Y(t){let e=["-v","error","-show_format","-show_streams"];if(typeof t=="string")return N(A.path,[...e,t]);throw new Error("Given input was not a string")}function v(t){return new Date(1e3*t).toISOString().substring(11,19)}function j(t){return new Date(t).toLocaleString("en-US",{day:"numeric",hour:"2-digit",hour12:!1,minute:"2-digit",month:"short",year:"numeric"})}async function b(t){try{let{stdout:e}=await Y(t),o=e.match(/duration="?(\d*\.\d*)"?/);if(o&&o[1])return parseFloat(o[1]);throw new Error("No duration found!")}catch(e){return console.error(e),0}}function D(t){try{return M.statSync(t).mtimeMs||-1}catch(e){return console.error(e),-1}}function f(t,e,o,i){let r=J(e);return r[o]=i,`/f/${u(t)}?${X.stringify(r)}`}function F(t,e){let o=[r=>r.type==="folder",r=>r.name.match(/^\W+/)===null,r=>r.name.toLowerCase()],i=["desc","asc","asc"];switch(e){case"duration":o.splice(1,0,r=>r.raw_duration||0),i.splice(1,0,"desc");break;case"last_updated":o.splice(1,0,r=>r.raw_last_updated||-1),i.splice(1,0,"desc");break;default:break}return K(t,o,i)}function u(t){let e=t.replace(/\/+/g,"/");return e.startsWith("/")?e.substring(1):e}function C(t,e){let o=t.split("/").filter(r=>!!r),i=Q(o,"f");return[{label:"Root",skip_link:t==="/",url:`/${e?`?${e}`:""}`},...i.map((r,s)=>{let m=`/f/${i.slice(0,s+1).join("/")}${e?`?${e}`:""}`;return{label:r,url:m,skip_link:s===i.length-1}})]}var q=Object.freeze(["list","grid"]),tt=Object.freeze(["name","duration","last_updated"]);async function et(t,e,o,i,r){let s=q.includes(t.query.view?.toLowerCase())?t.query.view.toLowerCase():"list",m=tt.includes(t.query.sort?.toLowerCase())?t.query.sort.toLowerCase():"name",S=_.readdirSync(i,{withFileTypes:!0});if(r.startsWith("/.thumbnails"))return e.view("404").code(404);let h=[];for(let w=0;w<S.length;w+=1){let a=S[w],y=a.isDirectory();if(a.name===".thumbnails")continue;let B=encodeURIComponent(a.name),G=p.join(i,B),H=p.relative(o,G),l=p.join(i,a.name),R=D(l),n={icon:y?"ri-folder-line":"ri-file-line",last_updated:j(R),name:a.name,path:`/f/${u(H)}?${I.stringify(t.query)}`,raw_last_updated:R,type:y?"folder":"file"};if(!y){let g=await Z(l);if(g?.mime?.startsWith("image"))n.icon="ri-image-2-line",n.type="image",s==="grid"&&(n.src=`/f/${u(r)}/${a.name}`);else if(g?.mime?.startsWith("video")){n.icon="ri-film-line",n.type="video";let c=await b(l);n.duration=v(c),n.raw_duration=c;let $=a.name.replace(p.extname(a.name),".png"),P=p.join(o,".thumbnails",r,$);_.existsSync(P)&&(n.thumbnail=`/f/.thumbnails/${u(r)}/${u(encodeURIComponent($))}`)}else if(g?.mime?.startsWith("audio")){n.icon="ri-headphone-line",n.type="audio";let c=await b(l);n.duration=v(c),n.raw_duration=c}l.toLowerCase().endsWith(".url")&&(n.icon="ri-external-link-line",_.readFileSync(l).toString("utf8").split(`
`).forEach(c=>{c.trim().startsWith("URL=")&&(n.external_url=c.split("=")[1])}))}h.push(n)}h=F(h,m);let E=I.stringify(t.query),L=C(r,E);return e.view("page",{breadcrumbs:L,duration_sort_url:f(r,t.query,"sort","duration"),files:h,grid_view_url:f(r,t.query,"view","grid"),last_updated_sort_url:f(r,t.query,"sort","last_updated"),list_view_url:f(r,t.query,"view","list"),name_sort_url:f(r,t.query,"sort","name"),previous_url:r==="/"?null:`/${u(L.at(-1).url)}`,root_url:`/?${E}`,sort_param:m,view_param:s})}function rt(t,e){return t.file(e,{confine:!1,mode:"inline",etagMethod:"simple"}).code(200)}var T={method:"GET",path:"/f/{any*}",handler:function(t,e){try{let{root_path:o}=e.request.server.settings.app,i=decodeURIComponent(t.path).replace(/^\/f/,"").replace(/\/+/g,"/")||"/",r=p.join(o,i),s=_.statSync(r);return s.isDirectory()?et(t,e,o,r,i):s.isFile()?rt(e,r):e.view("404").code(404)}catch{return e.view("404").code(404)}}};var k={method:"*",path:"/{any*}",handler:function(t,e){return e.view("404").code(404)}};async function at(){let t=d.file_source;if(!t)throw"No file source path provided";if(!W.existsSync(t)||!W.statSync(t).isDirectory())throw"Invalid file source path provided";O.registerHelper("ifEquals",function(i,r,s){return i==r?s.fn(this):s.inverse(this)});let e=x.resolve("."),o=ot.server({app:{__dirname:e,config:d,root_path:t},port:d.port,host:d.host,router:{stripTrailingSlash:!0},routes:{files:{relativeTo:t}},query:{parser:i=>st.parse(i)}});await o.register(it),await o.register(nt),o.views({engines:{html:O},relativeTo:e,path:x.join(e,"server","templates"),partialsPath:x.join(e,"server","templates","partials")}),o.ext("onRequest",(i,r)=>(i.path==="/"&&i.setUrl("/f"),r.continue)),o.route(T),o.route(U),o.route(k),await o.start(),console.log("Server running on %s",o.info.uri)}process.on("unhandledRejection",t=>{console.error(t),process.exit(1)});at();
//# sourceMappingURL=index.js.map
