import W from"fs";import E from"path";import st from"@hapi/hapi";import at from"@hapi/inert";import ct from"@hapi/log";import ut from"@hapi/vision";import O from"handlebars";import lt from"qs";import z from"dotenv";z.config();var m={file_source:process.argv[2]||process.env.FILE_SERVER_FILES_SOURCE,host:process.env.FILE_SERVER_HOST||"0.0.0.0",port:process.env.FILE_SERVER_PORT||3e3};import M from"path";var j={method:"GET",path:"/{any*}",handler:function(t,e){try{return e.file(M.join(e.request.server.settings.app.__dirname,"server",t.path),{confine:!1})}catch{return e.view("404").code(404)}}};import y from"fs";import d from"path";import{fileTypeFromFile as tt}from"file-type";import et from"qs";import N from"fs";import{execa as Q}from"execa";import A from"@ffprobe-installer/ffprobe";import{cloneDeep as J,isEmpty as K,orderBy as X,without as Y}from"lodash-es";import Z from"qs";function b(t){return t==="/"||t==="/f"}function q(t){let e=["-v","error","-show_format","-show_streams"];if(typeof t=="string")return Q(A.path,[...e,t]);throw new Error("Given input was not a string")}function x(t){return new Date(1e3*t).toISOString().substring(11,19)}function D(t){return new Date(t).toLocaleString("en-US",{day:"numeric",hour:"2-digit",hour12:!0,minute:"2-digit",month:"short",year:"numeric"})}async function S(t){try{let{stdout:e}=await q(t),o=e.match(/duration="?(\d*\.\d*)"?/);if(o&&o[1])return parseFloat(o[1]);throw new Error("No duration found!")}catch(e){return console.error(e),0}}function F(t){try{return N.statSync(t).mtimeMs||-1}catch(e){return console.error(e),-1}}function f(t,e,o,i){let r=J(e);return r[o]=i,`/f/${p(t)}${l(r)}`}function l(t){return K(t)?"":`?${Z.stringify(t)}`}function C(t,e){let o=[r=>r.type==="folder",r=>r.name.match(/^\W+/)===null,r=>r.name.toLowerCase()],i=["desc","asc","asc"];switch(e){case"duration":o.splice(1,0,r=>r.raw_duration||0),i.splice(1,0,"desc");break;case"last_updated":o.splice(1,0,r=>r.raw_last_updated||-1),i.splice(1,0,"desc");break;default:break}return X(t,o,i)}function p(t){let e=t.replace(/\/+/g,"/");return e.startsWith("/")?e.substring(1):e}function k(t,e){let o=t.split("/").filter(r=>!!r),i=Y(o,"f");return[{label:"Root",skip_link:b(t),url:`/f${l(e)}`},...i.map((r,s)=>{let h=`/f/${i.slice(0,s+1).join("/")}${l(e)}`;return{label:r,url:h,skip_link:s===i.length-1}})]}var rt=Object.freeze(["list","grid"]),ot=Object.freeze(["name","duration","last_updated"]);async function it(t,e,o,i,r){let s=rt.includes(t.query.view?.toLowerCase())?t.query.view.toLowerCase():"list",h=ot.includes(t.query.sort?.toLowerCase())?t.query.sort.toLowerCase():"name",L=y.readdirSync(i,{withFileTypes:!0});if(r.startsWith("/.thumbnails"))return e.view("404").code(404);let _=[];for(let w=0;w<L.length;w+=1){let a=L[w];if(a.isSymbolicLink())continue;let g=a.isDirectory();if(a.name===".thumbnails")continue;let G=encodeURIComponent(a.name),H=d.join(i,G),P=d.relative(o,H),u=d.join(i,a.name),U=F(u),n={icon:g?"ri-folder-fill":"ri-file-line",last_updated:D(U),name:a.name,path:`/f/${p(P)}${l(t.query)}`,raw_last_updated:U,type:g?"folder":"file"};if(!g){let v=await tt(u);if(v?.mime?.startsWith("image"))n.icon="ri-image-2-line",n.type="image",s==="grid"&&(n.src=`/f/${p(r)}/${a.name}`);else if(v?.mime?.startsWith("video")){n.icon="ri-film-line",n.type="video";let c=await S(u);n.duration=x(c),n.raw_duration=c;let $=a.name.replace(d.extname(a.name),".png"),V=d.join(o,".thumbnails",r,$);y.existsSync(V)&&(n.thumbnail=`/f/.thumbnails/${p(r)}/${p(encodeURIComponent($))}`)}else if(v?.mime?.startsWith("audio")){n.icon="ri-headphone-line",n.type="audio";let c=await S(u);n.duration=x(c),n.raw_duration=c}u.toLowerCase().endsWith(".url")&&(n.icon="ri-external-link-line",y.readFileSync(u).toString("utf8").split(`
`).forEach(c=>{c.trim().startsWith("URL=")&&(n.external_url=c.split("=")[1])}))}_.push(n)}_=C(_,h);let R=et.stringify(t.query),B=k(r,R);return e.view("page",{at_root:b(r),breadcrumbs:B,duration_sort_url:f(r,t.query,"sort","duration"),files:_,grid_view_url:f(r,t.query,"view","grid"),last_updated_sort_url:f(r,t.query,"sort","last_updated"),list_view_url:f(r,t.query,"view","list"),name_sort_url:f(r,t.query,"sort","name"),root_url:`/f${l(R)}`,sort_param:h,view_param:s})}function nt(t,e){return t.file(e,{confine:!1,mode:"inline",etagMethod:"simple"}).code(200)}var I={method:"GET",path:"/f/{any*}",handler:function(t,e){try{let{root_path:o}=e.request.server.settings.app,i=decodeURIComponent(t.path).replace(/^\/f/,"").replace(/\/+/g,"/")||"/",r=d.join(o,i),s=y.statSync(r);return s.isDirectory()?it(t,e,o,r,i):s.isFile()?nt(e,r):e.view("404").code(404)}catch{return e.view("404").code(404)}}};var T={method:"*",path:"/{any*}",handler:function(t,e){return e.view("404").code(404)}};async function ft(){let t=m.file_source;if(!t)throw"No file source path provided";if(!W.existsSync(t)||!W.statSync(t).isDirectory())throw"Invalid file source path provided";O.registerHelper("ifEquals",function(i,r,s){return i==r?s.fn(this):s.inverse(this)});let e=E.resolve("."),o=st.server({app:{__dirname:e,config:m,root_path:t},port:m.port,host:m.host,router:{stripTrailingSlash:!0},routes:{files:{relativeTo:t}},query:{parser:i=>lt.parse(i)}});await o.register(at),await o.register(ct),await o.register(ut),o.plugins.log.setLevel("notice"),o.views({engines:{html:O},relativeTo:e,path:E.join(e,"server","templates"),partialsPath:E.join(e,"server","templates","partials")}),o.ext("onRequest",(i,r)=>(i.path==="/"&&i.setUrl("/f"),r.continue)),o.route(I),o.route(j),o.route(T),await o.start(),console.log("Server running on %s",o.info.uri)}process.on("unhandledRejection",t=>{console.error(t),process.exit(1)});ft();
//# sourceMappingURL=index.js.map
