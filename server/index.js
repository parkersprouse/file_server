import C from"fs";import x from"path";import tt from"@hapi/hapi";import et from"@hapi/inert";import rt from"@hapi/vision";import I from"handlebars";import ot from"qs";import P from"dotenv";P.config();var d={file_source:process.argv[2]||process.env.FILE_SERVER_FILES_SOURCE,host:process.env.FILE_SERVER_HOST||"0.0.0.0",port:process.env.FILE_SERVER_PORT||3e3};import V from"path";var U={method:"GET",path:"/{any*}",handler:function(t,e){try{return e.file(V.join(e.request.server.settings.app.__dirname,"server",t.path),{confine:!1})}catch{return e.view("404").code(404)}}};import h from"fs";import u from"path";import{fileTypeFromFile as A}from"file-type";import{cloneDeep as J,orderBy as K}from"lodash-es";import _ from"qs";import z from"fs";import{execa as M}from"execa";import N from"@ffprobe-installer/ffprobe";function B(t){let e=["-v","error","-show_format","-show_streams"];if(typeof t=="string")return M(N.path,[...e,t]);throw new Error("Given input was not a string")}async function g(t){try{let{stdout:e}=await B(t),o=e.match(/duration="?(\d*\.\d*)"?/);if(o&&o[1])return parseFloat(o[1]);throw new Error("No duration found!")}catch(e){return console.error(e),0}}function S(t){return new Date(1e3*t).toISOString().substring(11,19)}function j(t){try{return z.statSync(t).mtimeMs||-1}catch(e){return console.error(e),-1}}function D(t){return new Date(t).toLocaleString("en-US",{day:"numeric",hour:"2-digit",hour12:!1,minute:"2-digit",month:"short",year:"numeric"})}var Q=Object.freeze(["list","grid"]),X=Object.freeze(["name","duration","last_updated"]);async function Y(t,e,o,i,r){let a=Q.includes(t.query.view?.toLowerCase())?t.query.view.toLowerCase():"list",E=X.includes(t.query.sort?.toLowerCase())?t.query.sort.toLowerCase():"name",b=h.readdirSync(i,{withFileTypes:!0});if(r.startsWith("/.thumbnails"))return e.view("404").code(404);let m=[];for(let y=0;y<b.length;y+=1){let s=b[y],w=s.isDirectory();if(s.name===".thumbnails")continue;let O=encodeURIComponent(s.name),k=u.join(i,O),G=u.relative(o,k),l=u.join(i,s.name),L=j(l),n={icon:w?"ri-folder-line":"ri-file-line",last_updated:D(L),name:s.name,path:`/f/${f(G)}?${_.stringify(t.query)}`,raw_last_updated:L,type:w?"folder":"file"};if(!w){let v=await A(l);if(v?.mime?.startsWith("image"))n.icon="ri-image-2-line",n.type="image",a==="grid"&&(n.src=`/f/${f(r)}/${s.name}`);else if(v?.mime?.startsWith("video")){n.icon="ri-film-line",n.type="video";let c=await g(l);n.duration=S(c),n.raw_duration=c;let R=s.name.replace(u.extname(s.name),".png"),H=u.join(o,".thumbnails",r,R);h.existsSync(H)&&(n.thumbnail=`/f/.thumbnails/${f(r)}/${f(encodeURIComponent(R))}`)}else if(v?.mime?.startsWith("audio")){n.icon="ri-headphone-line",n.type="audio";let c=await g(l);n.duration=S(c),n.raw_duration=c}l.toLowerCase().endsWith(".url")&&(n.icon="ri-external-link-line",h.readFileSync(l).toString("utf8").split(`
`).forEach(c=>{c.trim().startsWith("URL=")&&(n.external_url=c.split("=")[1])}))}m.push(n)}m=q(m,E);let T=`/?${_.stringify(t.query)}`,W=t.path==="/f"?null:`/f/${f(u.join(r,".."))}?${_.stringify(t.query)}`;return e.view("page",{duration_sort_url:p(r,t.query,"sort","duration"),files:m,grid_view_url:p(r,t.query,"view","grid"),last_updated_sort_url:p(r,t.query,"sort","last_updated"),list_view_url:p(r,t.query,"view","list"),name_sort_url:p(r,t.query,"sort","name"),previous_url:W,root_url:T,sort_param:E,view_param:a})}function Z(t,e){return t.file(e,{confine:!1,mode:"inline",etagMethod:"simple"}).code(200)}function p(t,e,o,i){let r=J(e);return r[o]=i,`/f/${f(t)}?${_.stringify(r)}`}function q(t,e){let o=[r=>r.type==="folder",r=>r.name.match(/^\W+/)===null,r=>r.name.toLowerCase()],i=["desc","asc","asc"];switch(e){case"duration":o.splice(1,0,r=>r.raw_duration||0),i.splice(1,0,"desc");break;case"last_updated":o.splice(1,0,r=>r.raw_last_updated||-1),i.splice(1,0,"desc");break;default:break}return K(t,o,i)}function f(t){return t.startsWith("/")?t.substring(0):t}var F={method:"GET",path:"/f/{any*}",handler:function(t,e){try{let{root_path:o}=e.request.server.settings.app,i=decodeURIComponent(t.path).replace(/^\/f/,"");console.log(i);let r=u.join(o,i),a=h.statSync(r);return a.isDirectory()?Y(t,e,o,r,i):a.isFile()?Z(e,r):e.view("404").code(404)}catch{return e.view("404").code(404)}}};var $={method:"*",path:"/{any*}",handler:function(t,e){return e.view("404").code(404)}};async function it(){let t=d.file_source;if(!t)throw"No file source path provided";if(!C.existsSync(t)||!C.statSync(t).isDirectory())throw"Invalid file source path provided";I.registerHelper("ifEquals",function(i,r,a){return i==r?a.fn(this):a.inverse(this)});let e=x.resolve("."),o=tt.server({app:{__dirname:e,config:d,root_path:t},port:d.port,host:d.host,router:{stripTrailingSlash:!0},routes:{files:{relativeTo:t}},query:{parser:i=>ot.parse(i)}});await o.register(et),await o.register(rt),o.views({engines:{html:I},relativeTo:e,path:x.join(e,"server","templates"),partialsPath:x.join(e,"server","templates","partials")}),o.ext("onRequest",(i,r)=>(i.path==="/"&&i.setUrl("/f"),r.continue)),o.route(F),o.route(U),o.route($),await o.start(),console.log("Server running on %s",o.info.uri)}process.on("unhandledRejection",t=>{console.error(t),process.exit(1)});it();
//# sourceMappingURL=index.js.map
